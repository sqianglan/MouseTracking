<!DOCTYPE html>
<html>
<head>
    <title>Scroll Position Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
</head>
<body>
    <h1>DataTable Scroll Position Test</h1>
    
    <button onclick="saveScrollPosition('example')">Save Scroll Position</button>
    <button onclick="restoreScrollPosition('example', 0)">Restore Scroll Position</button>
    <button onclick="refreshTable()">Refresh Table (Simulate DataTable refresh)</button>
    
    <div style="margin: 20px 0;">
        <strong>Console Output:</strong> <span id="console-output"></span>
    </div>
    
    <table id="example" class="display" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Age</th>
                <th>Start date</th>
                <th>Salary</th>
                <th>Extra 1</th>
                <th>Extra 2</th>
                <th>Extra 3</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // Include our scroll position functions
        window.scrollPositions = window.scrollPositions || {};

        function saveScrollPosition(tableId) {
            try {
                console.log('=== SAVE SCROLL: Starting for table:', tableId);
                
                var savedTop = 0;
                var savedLeft = 0;
                var containerFound = false;
                
                // Try to find the scroll container in order of preference
                var containers = [
                    '#' + tableId + '_wrapper .dataTables_scrollBody',  // Primary scroll body
                    '#' + tableId + '_wrapper',                         // Table wrapper
                    '.dataTables_wrapper:has(#' + tableId + ')',       // Any wrapper containing our table
                ];
                
                for (var i = 0; i < containers.length; i++) {
                    var container = $(containers[i]);
                    console.log('Trying container:', containers[i], 'Found:', container.length);
                    
                    if (container.length > 0) {
                        savedTop = container.scrollTop();
                        savedLeft = container.scrollLeft();
                        console.log('Container scroll position:', savedTop, savedLeft);
                        
                        if (savedTop > 0 || savedLeft > 0 || i === 0) { // Accept first valid container
                            containerFound = true;
                            console.log('Found active scroll in:', containers[i]);
                            break;
                        }
                    }
                }
                
                // If no container scroll found, try window scroll
                if (!containerFound) {
                    savedTop = $(window).scrollTop();
                    savedLeft = $(window).scrollLeft();
                    console.log('Using window scroll:', savedTop, savedLeft);
                }
                
                // Save the position
                window.scrollPositions[tableId] = {
                    top: savedTop,
                    left: savedLeft,
                    timestamp: Date.now(),
                    source: containerFound ? 'container' : 'window'
                };
                
                document.getElementById('console-output').textContent = 'Saved: ' + JSON.stringify(window.scrollPositions[tableId]);
                console.log('=== SAVE SCROLL: Completed for', tableId + ':', window.scrollPositions[tableId]);
                
            } catch (err) {
                console.error('=== SAVE SCROLL: Error for', tableId + ':', err);
            }
        }

        function restoreScrollPosition(tableId, delay) {
            setTimeout(function() {
                try {
                    if (!window.scrollPositions || !window.scrollPositions[tableId]) {
                        console.log('No saved scroll position found for:', tableId);
                        return;
                    }
                    
                    var savedPosition = window.scrollPositions[tableId];
                    console.log('Attempting to restore scroll position for ' + tableId + ':', savedPosition);
                    
                    var restored = false;
                    
                    // Try the same containers as save
                    var containers = [
                        '#' + tableId + '_wrapper .dataTables_scrollBody',
                        '#' + tableId + '_wrapper',
                        '.dataTables_wrapper:has(#' + tableId + ')',
                    ];
                    
                    for (var i = 0; i < containers.length; i++) {
                        var container = $(containers[i]);
                        if (container.length > 0) {
                            container.scrollTop(savedPosition.top);
                            container.scrollLeft(savedPosition.left);
                            console.log('Restored using:', containers[i]);
                            restored = true;
                            break;
                        }
                    }
                    
                    if (!restored && savedPosition.source === 'window') {
                        $(window).scrollTop(savedPosition.top);
                        $(window).scrollLeft(savedPosition.left);
                        console.log('Restored using window scroll');
                        restored = true;
                    }
                    
                    document.getElementById('console-output').textContent = 'Restored: ' + (restored ? 'Success' : 'Failed');
                    
                } catch (err) {
                    console.error('Error in restoreScrollPosition:', err);
                }
            }, delay || 100);
        }

        function refreshTable() {
            // Simulate a table refresh
            saveScrollPosition('example');
            
            // Destroy and recreate the table (simulating Shiny behavior)
            $('#example').DataTable().destroy();
            
            setTimeout(function() {
                // Recreate the table
                $('#example').DataTable({
                    scrollX: true,
                    data: generateData(),
                    columns: [
                        { title: "ID" },
                        { title: "Name" },
                        { title: "Position" },
                        { title: "Office" },
                        { title: "Age" },
                        { title: "Start date" },
                        { title: "Salary" },
                        { title: "Extra 1" },
                        { title: "Extra 2" },
                        { title: "Extra 3" }
                    ]
                });
                
                // Restore scroll position
                restoreScrollPosition('example', 200);
            }, 100);
        }

        function generateData() {
            var data = [];
            for (var i = 1; i <= 100; i++) {
                data.push([
                    i,
                    'Name ' + i,
                    'Position ' + i,
                    'Office ' + i,
                    Math.floor(Math.random() * 40) + 20,
                    '2023-01-' + String(i % 28 + 1).padStart(2, '0'),
                    '$' + (Math.floor(Math.random() * 50000) + 30000),
                    'Extra data ' + i + '-1',
                    'Extra data ' + i + '-2',
                    'Extra data ' + i + '-3'
                ]);
            }
            return data;
        }

        // Initialize the table
        $(document).ready(function() {
            $('#example').DataTable({
                scrollX: true,
                data: generateData(),
                columns: [
                    { title: "ID" },
                    { title: "Name" },
                    { title: "Position" },
                    { title: "Office" },
                    { title: "Age" },
                    { title: "Start date" },
                    { title: "Salary" },
                    { title: "Extra 1" },
                    { title: "Extra 2" },
                    { title: "Extra 3" }
                ]
            });
        });
    </script>
</body>
</html>
